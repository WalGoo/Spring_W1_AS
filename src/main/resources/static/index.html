<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spring 개인과제</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>

        // 당직 2연탕보다 더 졸려 미치겠다

        // 값 비었는지 검사
        function isitnull(what) {
            if (what != "contents") {
                return $(`#${what}`).val().trim() != "";
            } else {
                return $(`#${what}`).val().trim() !== '';
            }
        }


        // temphtml 자동 기입, ajax call도 만들까
        function tempHtmlAdd(id, nickname, herotype, modifiedAt, contents) {

            let temphtml = `<div>
                                            <div><span id="nickname-${id}">닉네임 : ${nickname}</span></div>
                                            <div><span id="herotype-${id}">직업 : ${herotype}  </span></div>
                                            <div class="date">수정 일자 : ${modifiedAt}</div>
                                            <p>================================================</p>
                                            <div id="contents-${id}">${contents}</div>
                                            <p>================================================</p>
                                            <div>
                                                <button onclick=showbtn(${id})>수정</button>
                                                <button onclick=showbtn2(${id})>삭제</button>
                                            </div>
                                            <div>
                                                <div><input placeholder="비밀번호 입력" style="display: none;" id="DoDelPassword-${id}"></div>
                                                <div><button id="realDelBtn-${id}" style="display: none;" onclick="makeDeleteOrder(${id})">GG</button></div>
                                                <div><textarea style="display:none;" class="editContents" id="editContents-${id}"></textarea></div>
                                                <div><input style="display:none;" id="password-${id}" type="password" placeholder="비밀번호"></div>
                                                <div><button onclick=submitEdit(${id}) style="display: none;" id="editdone-${id}">수정 완료</button></div>
                                            </div>
                                        </div>`

            $('#contentlist').append(temphtml);
            console.log(modifiedAt);

        }

        // 첫 접속 시 조회
        $(document).ready(function () {
            GetContentsList();
        })

        // show 해주기
        function showbtn(id) {
            $(`#editContents-${id}`).show();
            $(`#editdone-${id}`).show();
            $(`#password-${id}`).show();
        }

        function showbtn2(id) {
            $(`#DoDelPassword-${id}`).show();
            $(`#realDelBtn-${id}`).show();
        }


        // 전체 조회
        function GetContentsList() {
            $('#contentlist').empty();
            $.ajax({
                type: 'GET',
                url: '/api/hsDecks',
                data: {},
                success: function (response) {
                    console.log(response);

                    for (i = 0; i < response.length; i++) {
                        let decklist = response[i];
                        let id = decklist['id'];
                        let nickname = decklist['nickname'];
                        let contents = decklist['contents'];
                        let modifiedAt = decklist['modifiedAt'];
                        let herotype = decklist['heroType'];
                        console.log(modifiedAt);
                        tempHtmlAdd(id, nickname, herotype, modifiedAt, contents)
                    }
                }
            });
        }


        // 분류별 검색
        function GetAnotherList() {
            if ($('#searchtype').val() === "nickname") {

                let nickname = $('#searchnickname').val().trim();
                let data = {'nickname': nickname};
                $('#contentlist').empty();

                $.ajax({
                    type: 'POST',
                    url: `/api/nicknames/${nickname}`,
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function (response) {
                        console.log(response);
                        for (i = 0; i < response.length; i++) {
                            let decklist = response[i];
                            let id = decklist['id'];
                            let nickname = decklist['nickname'];
                            let contents = decklist['contents'];
                            let modifiedAt = decklist['modifiedAt'];
                            tempHtmlAdd(id, nickname, herotype, modifiedAt, contents)
                        }
                    }
                })
            } else if ($('#searchtype').val() === "herotype") {
                let herotype = $('#searchhero').val();
                let data = {'heroType': herotype};
                $('#contentlist').empty();
                $.ajax({
                    type: 'POST',
                    url: `/api/heroTypes/${herotype}`,
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function (response) {
                        console.log(response);
                        for (i = 0; i < response.length; i++) {
                            let decklist = response[i];
                            let id = decklist['id'];
                            let nickname = decklist['nickname'];
                            let contents = decklist['contents'];
                            let modifiedAt = decklist['modifiedAt'];
                            tempHtmlAdd(id, nickname, herotype, modifiedAt, contents)
                        }
                    }
                })
            } else if ($('#searchtype').val() == null) {
                alert("뭐하냐");
            }
        }

        // insert into
        function makeCreateOrder() {
            let nickname = $('#nickname').val().trim();
            let contents = $('#contents').val();
            let herotype = $('#selecthero').val();
            let password = $('#password').val();
            if (isitnull('contents') && isitnull('nickname') && isitnull('password') && isitnull('selecthero')) {
                let passwordcheck = $('#password-check').val();
                if (password === passwordcheck) {
                    let data = {'nickname': nickname, 'contents': contents, 'heroType': herotype, 'password': password};
                    $.ajax({
                        type: 'POST',
                        url: `/api/hsDecks`,
                        contentType: "application/json",
                        data: JSON.stringify(data),
                        success: function (response) {
                            window.location.reload();
                        }
                    })
                }
            } else {
                alert("제대로 넣어라");
            }
        }


        // 수정, 삭제 시 msg를 받아서 성공, 실패 여부 받기
        // ㄴ 우리 다음에 잘하자... 나 죽어.....

        // 수정 버튼
        function submitEdit(id) {
            let password = $(`#password-${id}`).val().trim();
            let contents = $(`#editContents-${id}`).val().trim();
            let data = {'contents': contents, 'password': password};
            $.ajax({
                type: "PUT",
                url: `/api/hsDecks/${id}`,
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    window.location.reload();
                }
            });
        }

        // 삭제 버튼
        function makeDeleteOrder(id) {
            let password = $(`#DoDelPassword-${id}`).val().trim();
            let data = {'password': password};
            $.ajax({
                type: "DELETE",
                url: `/api/hsDecks/${id}`,
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    window.location.reload();
                }
            })
        }

        // 검색 분류 선택 시 분류창 띄우기
        function hearthStoneIsTrashGame() {
            if($('#searchtype').val() === "nickname") {
                $('#searchnickname').show();
                $('#searchhero').hide();
            } else if($('#searchtype').val() === "herotype") {
                $('#searchnickname').hide();
                $('#searchhero').show();
            }
        }

    </script>
</head>
<body>

<h1>하스스톤 직업평</h1>
<br>

<!-- 글 조회 -->
<div>
    <select id="searchtype" onchange=hearthStoneIsTrashGame()>
        <option disabled selected>검색 분류</option>
        <option value="nickname">닉네임</option>
        <option value="herotype">직업</option>
    </select>
    <br>
    <input style="display: none;" placeholder="닉네임으로 검색" id="searchnickname">
    <select id="searchhero" style="display: none;">
        <option disabled selected>직업 선택</option>
        <option value="전사">전사</option>
        <option value="마법사">마법사</option>
        <option value="도적">도적</option>
        <option value="사제">사제</option>
        <option value="흑마법사">흑마법사</option>
        <option value="악마사냥꾼">무근본</option>
        <option value="드루이드">드루이드</option>
        <option value="주술사">주술사</option>
        <option value="사냥꾼">사냥꾼</option>
    </select>
    <button id="searchbtn" onclick=GetAnotherList()>조회</button>
</div>
<br>
<br>
<br>
<!-- 글 작성 -->
<div>
    <textarea placeholder="직업평" id="contents"></textarea> <br>
    <select id="selecthero">
        <option disabled selected>직업 선택</option>
        <option value="전사">전사</option>
        <option value="마법사">마법사</option>
        <option value="도적">도적</option>
        <option value="사제">사제</option>
        <option value="흑마법사">흑마법사</option>
        <option value="악마사냥꾼">악마사냥꾼</option>
        <option value="드루이드">드루이드</option>
        <option value="주술사">주술사</option>
        <option value="사냥꾼">사냥꾼</option>
    </select>
    <input type="text" placeholder="닉네임" id="nickname">
    <br>
    <input type="password" placeholder="패스워드" id="password">
    <input type="password" placeholder="패스워드 재입력" id="password-check">
    <br>
    <button onclick=makeCreateOrder() id="donebtn">작성완료</button>
</div>
<!-- 글 목록 -->
<div id="contentlist">

</div>
</body>
</html>